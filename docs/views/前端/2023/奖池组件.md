---
title: 奖池组件
date: 2023-06-30
sidebar: auto
tags:
  - js
  - Vue
categories:
  - 前端
sticky: 2
---

## 奖池组件的封装(动态的奖池和表格内容)

### 最外层的渲染组件

```javascript
<template>
<div>
  <cro-jackpot-methods
    ref="jackpotMethods"
    :appId="150"
    :columns="smallPrizeColumns"
    :gameId="0"
    :prizePoolList="prizePoolList"
    :whichPage="pageType === 0 ? 'add' : 'edit'"
  ></cro-jackpot-methods>
</div>
</template>
<script>
//表头
const smallPrizeColumns = [
{
  title: '奖券ID',
  dataIndex: 'couponId',
  key: 'couponId',
  width: 80,
},
{
  title: '奖券名称',
  dataIndex: 'couponName',
  scopedSlots: { customRender: 'couponName' },
  width: 120,
},
{
  title: '发放量',
  dataIndex: 'residue',
  width: 80,
  scopedSlots: { customRender: 'residue' },
},
{
  title: '绑定量',
  dataIndex: 'amount',
  width: 80,
  scopedSlots: { customRender: 'amount' },
},
{
  title: '剩余量',
  dataIndex: 'stock',
  width: 120,
  scopedSlots: { customRender: 'stock' },
},
{
  title: '权重',
  dataIndex: 'weight',
  width: 120,
  scopedSlots: { customRender: 'weight' },
},
{
  title: '券有效期',
  scopedSlots: { customRender: 'dateStr' },
  width: 120,
},
{
  title: '操作',
  width: 120,
  dataIndex: 'operation',
  scopedSlots: { customRender: 'operation' },
  },
 ]
const prizePoolList = [
//奖池
{
  annotate: '大奖奖品在转盘中展示为幸运奖，最少配置1个，当配置多个奖品时将按照中奖概率随机发放。',
  title: '小奖奖池',
  limitList: [
    {
      target: 3, //4、参与限制 3、奖池领取上线 2、中大奖的次数
      type: 0, //0是不限制 1是每天 2是总共
      value: '',
    },
  ],
  probability: '', //大奖中奖概率
  poolPriority: 0, //奖池类型
  prizeReleaseBeans: [], //奖券数据
},
{
  annotate: '幸运奖品将优先展示在视觉焦点区域，仅在本游戏内有效。',
  title: '幸运奖池',
  limitList: [
    {
      target: 3, //4、参与限制 3、奖池领取上线 2、中大奖的次数
      type: 0, //0是不限制 1是每天 2是总共
      value: '',
    },
  ],
  probability: '', //大奖中奖概率
  poolPriority: 1, //奖池类型
  prizeReleaseBeans: [], //奖券数据
},
]
export default {
data() {
  return {
    prizePoolList,
    gameId: +this.$route.query.gameId,
    smallPrizeColumns,
  }
},
async mounted() {
  await this.$refs.jackpotMethods.initJackpot({
    shopId: 21835801,
    gameId: 0,
  })
},
methods: {
  async saveJackpot() {
    const JackpotCheck = await this.$refs.jackpotMethods.validate()
    console.log(JackpotCheck)
    const jackpotSave = await this.$refs.jackpotMethods.saveJackpot({
      gameId: +this.$route.query.gameId,
      shopId: +this.$route.query.shopId || '',
    })
    console.log('jackpotSave', jackpotSave)
  },
 },
 }
</script>
```

### 父组件负责提供方法（初始化数据，保存表格数据，校验表格数据）

```javascript
<template>
<div>
  <div v-for="(item, index) in prizePoolList" :key="index">
    <Jackpot
      :ref="`jackpot${index}`"
      :id="`jackpot${index}`"
      :key="item.poolPriority"
      :title="item.title"
      :whichPage="whichPage"
      :annotate="item.annotate"
      :columns="columns"
      :appId="appId"
      :poolPriority="item.poolPriority"
      :gameId="gameId"
      @upDataList="upDataList"
      @getData="getData"
      @upRemoveData="upRemoveData"
    >
    </Jackpot>
  </div>
</div>
</template>
<script>
import { getCouponList, saveCouponList } from '~packages/api/jackpot/index.js'
import Jackpot from './jackpot.vue'
export default {
name: 'CroJackpotMethods',
components: {
  Jackpot,
},
props: {
  whichPage: {
    //操作类型（编辑还是新建）
    type: String,
    default: '',
  },
  columns: {
    // 表头
    type: Array,
    required: true,
  },
  prizePoolList: {
    // table数据
    type: Array,
    required: true,
  },
  appId: {
    type: Number,
    required: true,
  },
  gameId: {
    type: Number,
    required: true,
  },
},

data() {
  return {
    jackpotRefs: [], //奖池的refs数组
    tableList: [], //奖券的数据
    tableLists: [], //拼接两个奖券的数据
  }
},
methods: {
  //移除更新奖券
  upRemoveData(upRemoveData) {
    this.tableLists = this.tableLists.filter(item => {
      return item.couponId != upRemoveData
    })
  },
  //获取到的数据给到拼接的数组tableLists
  getData(addTableList) {
    this.tableLists.push(...addTableList)
    //筛选出重复的券（循环了组件 会有重复的券）
    this.tableLists = this.tableLists.filter((item, index, self) => {
      return self.findIndex(t => t.couponId === item.couponId) === index
    })
    this.tableList = addTableList
  },
  // //init的时候把全部数据给回tableLists
  upDataList(upDataList) {
    this.tableLists = upDataList
  },
  //校验
  async validate() {
    let flag
    for (let i = 0; i < this.prizePoolList.length; i++) {
      const valid = await this.$refs[`jackpot${i}`][0].validate()
      flag = valid && this.$refs[`jackpot${i}`][0].tableList.length == 0
      if (!valid) {
        this.$message.error('请完善数据')
        throw new Error(`jackpot${i} validation failed`)
      }
      if (this.$refs[`jackpot${i}`][0].tableList.length == 0) {
        this.$message.error('每个奖池的奖券最少要有一张')
        throw new Error(`jackpot${i} tableList length is 0`)
      }
      // return flag
    }
    return flag
  },
  // 保存奖池和奖券配置
  async saveJackpot({ shopId, gameId, activityId }) {
    let jackpotResult = {}
    const prizePoolList = [] //需要拼一个奖池数据
    //需要先做校验
    for (let i = 0; i < this.prizePoolList.length; i++) {
      const valid = await this.$refs[`jackpot${i}`][0].validate()
      if (!valid) {
        this.$message.error('请完善数据')
        throw new Error(`jackpot${i} validation failed`)
      }
      if (this.$refs[`jackpot${i}`][0].tableList.length == 0) {
        this.$message.error('每个奖池的奖券最少要有一张')
        throw new Error(`jackpot${i} tableList length is 0`)
      }
      this.jackpotRefs.push(this.$refs[`jackpot${i}`][0])
    }
    //拼接奖池数据
    for (let i = 0; i < this.jackpotRefs.length; i++) {
      const jackpotRef = this.jackpotRefs[i]
      const obj = {
        poolPriority: jackpotRef.poolPriority, //奖池类型
        limitList: [
          {
            target: 3, //4、参与限制 3、奖池领取上线 2、中大奖的次数
            type: jackpotRef._data.form.ceiling, //0是不限制 1是每天 2是总共
            value: jackpotRef._data.form.ceilingCount,
          },
        ],
        probability: jackpotRef._data.form.probability / 100, //大奖中奖概率
      }
      prizePoolList.push(obj)
    }
    const pass = true

    if (pass) {
      const data = {
        shopId,
        gameId,
        activityId,
        gamePrizeRuleBean: {
          prizeCondition: {
            diffPrize: 1, //是否开启大奖
            prizePoolList: prizePoolList,
          },
        },
        appId: this.appId,
        prizeReleaseBeans: this.tableLists, //奖券数据
      }
      jackpotResult = await saveCouponList(data)
      if (jackpotResult.data.status === 1) return Promise.reject(jackpotResult.data.errorMsg)
    }
    return jackpotResult //这个是接口返回的结果状态
  },
  async initJackpot({ shopId, gameId, activityId }) {
    //init获取回来的数据需要过滤判断一下 给到tableList
    const query = {
      shopId,
      gameId,
      activityId,
      appId: this.appId,
    }
    const res = await getCouponList(query)
    const info = res.data.object
    this.prizePoolList.forEach((item, index) => {
      const jackPotList = info.gamePrizeRuleBean.prizeCondition.prizePoolList
      item.limitList = jackPotList[index].limitList
      item.poolPriority = jackPotList[index].poolPriority
      item.probability = jackPotList[index].probability
      item.prizeReleaseBeans = info.prizeReleaseBeans
    })
    for (let i = 0; i < this.prizePoolList.length; i++) {
      this.jackpotRefs.push(this.$refs[`jackpot${i}`][0])
    }
    this.jackpotRefs.forEach((item, index) => item.init(this.prizePoolList[index]))
  },
  },
 }
</script>
```

### 子组件写样式和获取接口的数据

```javascript
export function to(promise, errorExt) {
<template>
<div class="jackpot-card">
  <a-card size="small">
    <template slot="title">
      <span>{{ title }}</span>
      <span class="annotate">
        {{ annotate }}
      </span>
    </template>
    <div>
      <a-form-model
        :model="form"
        layout="inline"
        v-if="poolPriority == 1"
        ref="form"
        :rules="rules"
      >
        <div>
          <a-form-model-item label="大奖中奖概率" prop="probability">
            <a-input
              class="width70 mlr10"
              v-model="form.probability"
              size="small"
              placeholder="请输入"
              @change="inputProbability(2)"
            ></a-input>
            <span>%</span>
          </a-form-model-item>
        </div>

        <a-form-model-item label="获奖上限" v-if="poolPriority == 1" prop="ceiling">
          <!--ceiling：0是不限制 1是每天 2是总共  -->
          <div>
            <a-radio-group v-model="form.ceiling" @change="changeCeiling">
              <a-radio :value="0">不限制</a-radio>
              <a-radio :value="2">限制</a-radio>
            </a-radio-group>
            <div>
              <a-form-model-item v-if="form.ceiling" prop="ceilingCount">
                <span>每个用户最多可领取</span>
                <a-input
                  class="width70 mlr10"
                  v-model="form.ceilingCount"
                  size="small"
                  placeholder="请输入"
                  @change="numberChange(form, 'ceilingCount', '99')"
                ></a-input>
                <span>份奖励</span>
              </a-form-model-item>
            </div>
          </div>
        </a-form-model-item>
      </a-form-model>
    </div>
    <div class="tab-box">
      <div class="head-title">奖品配置</div>
      <div class="taRight">
        <a-button type="primary" @click="openAddPrizeMethod">添加奖券</a-button>
      </div>
    </div>
    <div class="tableBox">
      <!-- :data-source="this.jackpotTableList" -->
      <a-table
        class="mt15"
        :columns="columns"
        :data-source="this.tableList"
        :rowKey="record => record.couponId"
        :pagination="false"
        :scroll="{ x: 1600 }"
      >
        <!-- 券ID -->
        <template slot="couponId" slot-scope="text, record">
          {{ record.couponId }}
        </template>
        <!-- 奖券名称 -->
        <template slot="couponName" slot-scope="text, record">
          <div class="name-box">
            <span class="text">{{ record.couponName }}</span>
          </div>
        </template>
        <!-- 发放量 -->
        <template slot="residue" slot-scope="text, record">
          <a-input
            v-model="record.residue"
            v-if="whichPage === ''"
            :class="checkRule(record, 'residue')"
            @change="inputEvent(record, 'residue')"
          />
          <div v-else>{{ record.residue }}</div>
        </template>
        <!-- 绑定量 -->
        <template slot="amount" slot-scope="text, record">
          <a-input
            v-model="record.amount"
            v-if="whichPage === ''"
            :class="checkRule(record, 'amount')"
            @change="inputEvent(record, 'amount')"
          />
          <div v-else>{{ record.amount }}</div>
        </template>
        <!-- 剩余量 -->
        <template slot="stock" slot-scope="text, record, index">
          <a-input
            v-model="record.stock"
            :class="checkRule(record, 'stock')"
            @change="inputEvent(record, 'stock', '', index)"
          />
        </template>
        <!-- 权重 -->
        <template slot="weight" slot-scope="text, record">
          <a-input
            v-model="record.weight"
            :class="checkRule(record, 'weight')"
            @change="inputEvent(record, 'weight')"
          />
        </template>
        <!-- 券有效期 -->
        <template slot="dateStr" slot-scope="text, record">
          {{ record.dateStr }}
        </template>
        <!-- 操作 -->
        <template slot="operation" slot-scope="text, record, index">
          <div class="operationButton">
            <a-button type="link" @click="delCoupon(record, index)">移除</a-button>
          </div>
        </template>
      </a-table>
    </div>
  </a-card>
  <!-- 拉券组件-->
  <couponWindows
    v-if="addPrizeVisible"
    :gameId="this.gameId"
    :appId="150"
    :shopId="$route.query.shopId ? $route.query.shopId : ''"
    ref="selectModel"
    :noAjax="true"
    :showNumber="true"
    :hasRights="true"
    :excludeCoupons="excludesCouponIds"
    @pullCoupon="pullCouponMethod"
  >
  </couponWindows>
</div>
 </template>
<script>
import { delCouponPost } from '../../api/jackpot/index'
import couponWindows from '../../CouponWindow/src/index.vue'
import lodash from 'lodash'
export default {
name: 'jackpot',
props: {
  whichPage: {
    //操作类型（编辑还是新建）
    type: String,
    default: '',
  },
  poolPriority: {
    // 当前奖池类型 （0 是小奖 1 是幸运奖 99 是超级大奖
    type: Number,
    // default: 0
  },
  title: {
    // 当前奖池名称
    type: String,
    default: '',
  },
  annotate: {
    // 奖池注解
    type: String,
    default: '',
  },
  columns: {
    // 表头
    type: Array,
    required: true,
  },
  appId: {
    type: Number,
    required: true,
  },
  gameId: {
    type: Number,
    required: true,
  },
},
components: {
  couponWindows,
},
data() {
  return {
    tableList: [], // 表格数据
    form: {
      //获奖规则数据
      ceiling: 0, //限制 ceiling：0是不限制 1是每天 2是总共
      ceilingCount: null, //限制的输入框
      probability: null, //中奖概率
    },
    prizeTab: 0, // 奖券状态
    addPrizeVisible: false, //是否打开拉圈弹窗
    rules: {
      ceiling: [{ required: true, message: '请选择获奖限制', trigger: 'blur' }],
      ceilingCount: [{ required: true, message: '请输入领取份数', trigger: 'blur' }],
      probability: [{ required: true, message: '请输入中奖概率', trigger: 'blur' }],
    },
    excludesCouponIds: [], // 拉券弹窗里需要禁用选择的券Id数组
  }
},
mounted() {},
methods: {
  //表格和input的校验
  validate() {
    return new Promise(resolve => {
      let tableList = this.tableList
      for (let i = 0; i < tableList.length; i++) {
        let stock = tableList[i].stock
        let weight = tableList[i].weight
        if (!stock) {
          this.$message.error('奖品配置剩余量不能为空！')
          return false
        }
        if (!weight) {
          this.$message.error('奖品配置权重不能为空！')
          return false
        }
      }
      if (this.$refs.form) {
        this.$refs.form.validate(valid => {
          if (valid) {
            resolve(true)
          } else {
            console.log('error reject!')
            resolve(false)
          }
        })
      } else {
        resolve(true)
      }
    })
  },
  pullCouponMethod(val) {
    val.forEach(item => {
      const detail = {
        notSave: true,
        couponId: item.sid, //券id
        couponName: item.name, //券名字
        dateStr: item.dateStr, //券有效期
        probability: 100, //中奖概率
        stock: +item.bindAmount, //剩余量
        amount: +(+item.bindAmount + +item.sendAmount), //绑定量
        residue: +item.sendAmount, //发放量
        isAdd: true,
        allowBindCount: item.allowBindCount, //剩余发放量的input
        poolPriority: this.poolPriority, //添加了奖池类型
      }
      this.tableList.unshift(detail)
      this.$emit('getData', this.tableList)
    })
    this.addPrizeVisible = false
  },
  //初始化数据
  init(itemList) {
    if (itemList.poolPriority == 1) {
      this.form.ceiling = itemList.limitList[0].type
      this.form.ceilingCount = itemList.limitList[0].value
      this.form.probability = itemList.probability *100
    }
    if (itemList.prizeReleaseBeans) {
      this.tableList = itemList.prizeReleaseBeans.map(item => {
        return (item.residue = +(item.amount - item.stock))
      })
      this.tableList = itemList.prizeReleaseBeans.filter(item => {
        return item.poolPriority == itemList.poolPriority
      })
      this.$emit('upDataList', itemList.prizeReleaseBeans)
    }
  },
  /* 删除奖券 */
  delCoupon: lodash.debounce(function (record) {
    const couponIdList = this.tableList
      .filter(item => item.couponId == record.couponId)
      .map(record => record.couponId)
    let that = this
    if (this.tableList.length > 1) {
      if (record.isAdd) {
        // 新拉的奖券
        const index = this.tableList.findIndex(item => item.couponId === record.couponId)
        this.tableList.splice(index, 1)
      } else {
        that.$confirm({
          title: '移除奖券',
          content: '当前移除操作会实时生效，确认是否移除奖券？',
          icon: 'exclamation-circle',
          onOk() {
            delCouponPost({
              appId: 150,
              gameId: that.gameId,
              couponIdList,
            }).then(res => {
              if (res.data.status == 0) {
                const index = that.tableList.findIndex(item => item.couponId === record.couponId)
                that.tableList.splice(index, 1)
                that.$message.success('移除成功！')
                that.$emit('upRemoveData', couponIdList)
              }
            })
          },
        })
      }
    } else {
      this.$message.error('最后一张奖券不能删除')
    }
  }, 500),
  //<获奖门槛>数组输入框修改监听
  numberChange(obj, key, max) {
    obj[key] = obj[key].toString().replace(/[^\d]/g, '')
    if (Number(obj[key]) <= 0) obj[key] = ''
    if (max && Number(obj[key]) > +max) obj[key] = max
    this.$refs.form.validateField('ceilingCount')
  },
  // <大奖中奖概率>输入框输入匹配规则
  inputProbability() {
    let reg = new RegExp(`^\\d*(\\d{0,${0}})`, 'g')
    this.form.probability = this.form.probability.match[reg](0)
    if (+this.form.probability > 100) {
      this.form.probability = '100'
    }
    this.$refs.form.validateField('probability')
  },
  // <获奖上限>的切换监听修改
  changeCeiling(e) {
    if (!e.target.value) {
      this.form.ceilingCount = ''
      this.$refs.form.validateField('ceilingCount')
    }
    this.numberChange(this.form, 'ceilingCount', '99')
  },
 // 点击添加奖券
  openAddPrizeMethod() {
    this.addPrizeVisible = true
    // 获取父元素的数据 把奖券一的数据筛选出来
    const jackpotRefs = this.$parent.tableList
    let tempJackpotTableList = []
    for (let i = 0; i < jackpotRefs.length; i++) {
      const jackpotRef = jackpotRefs[i]
      tempJackpotTableList = tempJackpotTableList.concat(jackpotRef)
    }
    this.excludesCouponIds = tempJackpotTableList.map(item => item.couponId)
    this.$nextTick(() => {
      this.$refs.selectModel.showModal()
    })
  },
  // <奖券配置>表格输入框的校验规则
  checkRule(record, key) {
    if (key === 'amount') {
      if (record.amount && record.amount <= record.allowBindCount) {
        return ''
      } else {
        return 'error-border'
      }
    } else if (key === 'stock') {
      if (record.stock && record.stock != 0) {
        return ''
      } else {
        return 'error-border'
      }
    } else if (key === 'weight') {
      if (record.weight && record.weight != 0) {
        return ''
      } else {
        return 'error-border'
      }
    } else {
      return ''
    }
  },
  // 输入框发生改变输入匹配规则
  inputEvent(record, key, num, index) {
    if (key === 'amount') {
      record.amount = record.amount.match[/^\d*/g](0)
      if (record.amount > record.allowBindCount) {
        record.amount = record.allowBindCount
        this.$message.error(`该奖品最多可投放${record.allowBindCount}个`)
      }
    } else if (key === 'stock') {
      record.stock = record.stock.match[/^\d*/g](0)
      if (record.stock > record.allowBindCount - record.residue) {
        record.stock = record.allowBindCount - record.residue
        this.$message.error(`该奖品可用库存${record.stock}个`)
      }
      if (record.stock === '0') {
        record.stock = 1
      }
      if (record.stock && record.stock >= 0) {
        record.amount = parseInt(record.stock) + parseInt(record.residue)
      } else {
        record.amount = record.residue
      }
      this.$set(this.tableList, index, record)
    } else if (key === 'weight') {
      record.weight = record.weight.match[/^\d*/g](0)
      if (record.weight === '0') {
        record.weight = 1
      } else if (record.weight > 99999) {
        record.weight = '99999'
      }
    } else {
      let reg = new RegExp(`^\\d*(\\.?\\d{0,${num}})`, 'g')
      record[key] = record[key].match[reg](0)
    }
  },
},
}
</script>
```

### 最终的效果是

![](./../../../.vuepress/public/icons/zj.jpg)
